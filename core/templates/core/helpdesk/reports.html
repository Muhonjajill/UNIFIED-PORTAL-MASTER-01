{% extends "base.html" %}
{% load static %}


{% block title %}Reports{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/reports.css' %}">

<div class="page-container">
  <h2><i class="fas fa-file-alt"></i> Reports</h2>
  <p>View system reports here.</p>

  <!-- Filters -->
  <form method="get" class="report-filters">
    <button type="submit" name="download" value="excel" class="btn btn-success" style="margin-top: 10px;">
      ðŸ“¥ Download Excel
    </button>

    <hr>
    
    <div class="row mb-3">
      <div class="col-md-3">
        <select name="customer" class="form-control">
          <option value="All">All Customers</option>
          {% for customer in customers %}
            <option value="{{ customer.id }}" {% if request.GET.customer == customer.id|stringformat:"s" %}selected{% endif %}>{{ customer.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <select name="terminal" class="form-control">
          <option value="All">All Terminals</option>
          {% for terminal in terminals %}
            <option value="{{ terminal.id }}" {% if request.GET.terminal == terminal.id|stringformat:"s" %}selected{% endif %}>{{ terminal.branch_name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <select name="region" class="form-control">
          <option value="All">All Regions</option>
          {% for region in regions %}
            <option value="{{ region.id }}" {% if request.GET.region == region.id|stringformat:"s" %}selected{% endif %}>{{ region.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <select name="category" class="form-control">
          <option value="All">All Categories</option>
          {% for category in categories %}
            <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <br><br>

    <!-- Date Filters -->
    <input type="text" id="start_date" name="start_date" class="date-picker" value="{{ request.GET.start_date }}" placeholder="Start Date" <i class="fa fa-calendar" aria-hidden="true" />>
    <input type="text" id="end_date" name="end_date" class="date-picker" value="{{ request.GET.end_date }}" placeholder="End Date" <i class="fa fa-calendar" aria-hidden="true"></i>>


    <button type="submit" class="btn">Filter</button>
  </form>

  <!-- Report Table -->
  <div class="table-responsive">
    <table class="report-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer</th>
          <th>Terminal</th>
          <th>Region</th>
          <th>Problem Category</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Description</th>
          <th>Responsible</th>
          <th>Created At</th>
        </tr>
      </thead>
      <tbody>
        {% for ticket in tickets %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ ticket.customer.name }}</td>
          <td>{{ ticket.terminal }}</td>
          <td>{{ ticket.region.name }}</td>
          <td>{{ ticket.problem_category.name }}</td>
          <td>{{ ticket.priority }}</td>
          <td>{{ ticket.status }}</td>
          <td>{{ ticket.description|truncatewords:10 }}</td>
          <td>{{ ticket.responsible }}</td>
          <td>{{ ticket.created_at }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9">No tickets found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script src="{% static 'js/ticketing_dashboard.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  flatpickr(".date-picker", {
    dateFormat: "Y-m-d",
    allowInput: true,
    defaultDate: null
  });
</script>
{% endblock %}
