{% extends "base.html" %}
{% load static %}

{% block title %}Reports{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/reports.css' %}">

<div class="page-container">
  <h2><i class="fas fa-file-alt"></i> Reports</h2>
  <p>View system reports here.</p>

  <!-- Filters -->
  <form method="get" class="report-filters">
    <button type="submit" name="download" value="excel" class="btn btn-success" style="margin-top: 10px;">
      ðŸ“¥ Download Excel
    </button>

    <hr>
    
    <div class="row mb-3">
      <div class="col-md-3">
        <select name="customer" class="form-control">
          <option value="All">All Customers</option>
          {% for customer in customers %}
            <option value="{{ customer.id }}" {% if request.GET.customer == customer.id|stringformat:"s" %}selected{% endif %}>{{ customer.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <input type="text" name="terminal_name" class="form-control" placeholder="Search Terminal by Branch Name" value="{{ request.GET.terminal_name }}">
      </div>

      <div class="col-md-3">
        <select name="region" class="form-control">
          <option value="All">All Regions</option>
          {% for region in regions %}
            <option value="{{ region.id }}" {% if request.GET.region == region.id|stringformat:"s" %}selected{% endif %}>{{ region.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <select name="category" class="form-control">
          <option value="All">All Categories</option>
          {% for category in categories %}
            <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <br><br>

    <!-- Date Filters -->
    <input type="text" id="start_date" name="start_date" class="date-picker" value="{{ request.GET.start_date }}" placeholder="Start Date">
    <input type="text" id="end_date" name="end_date" class="date-picker" value="{{ request.GET.end_date }}" placeholder="End Date">

    <button type="submit" class="btn">Filter</button>
  </form>

  <!-- Report Table -->
  {% if request.GET.terminal_name %}
    <!-- Table for Terminal filter -->
    <div class="table-responsive">
      <table class="report-table table table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Problem Category</th>
            <th>Status</th>
            <th>Responsible</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for ticket in tickets %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ ticket.created_at }}</td>
            <td>{{ ticket.updated_at }}</td>
            <td>{{ ticket.problem_category.name }}</td>
            <td>{{ ticket.status }}</td>
            <td>{{ ticket.responsible }}</td>
            <td>{{ ticket.description|truncatewords:10 }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="7">No tickets found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <!-- Table for Customer filter or all data -->
    <div class="table-responsive">
      <table class="report-table table table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Customer</th>
            <th>Terminal</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Problem Category</th>
            <th>Status</th>
            <th>Responsible</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for ticket in tickets %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ ticket.customer.name }}</td>
            <td>{{ ticket.terminal.branch_name }}</td>
            <td>{{ ticket.created_at }}</td>
            <td>{{ ticket.updated_at }}</td>
            <td>{{ ticket.problem_category.name }}</td>
            <td>{{ ticket.status }}</td>
            <td>{{ ticket.responsible }}</td>
            <td>{{ ticket.description|truncatewords:10 }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="10">No tickets found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}

</div>

<script src="{% static 'js/ticketing_dashboard.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  flatpickr(".date-picker", {
    dateFormat: "Y-m-d",
    allowInput: true,
    defaultDate: null
  });
</script>
{% endblock %}
